#!/usr/bin/env bash

CONFIG_PATH=$HOME/.config/dns/dns.list.d

HELP_MSG=$(
    cat <<EOF
Show/Set system DNS

Usage:
  dns [OPTION] [DNS]

Options:
  <no arg>                  show current DNS
  -i, --init                initialize the dns command config
  -s, --set <DNS>           setup given <DNS>
  -l, --list                list all DNS-configs
  -h, --help                show this help message

Example:
  dns -s shecan             # setup "shecan" DNS
  dns                       # print current DNS-config
EOF
)

ERROR_MSG="Bad usage"

################################################################################
# default dns configs

# https://shecan.ir/
dns_shecan=$(
    cat <<EOF
178.22.122.100
185.51.200.2
EOF
)

# https://403.online/
dns_403=$(
    cat <<EOF
10.202.10.202
10.202.10.102
EOF
)

################################################################################

function show-help {
    echo "$HELP_MSG"
    echo
}

function show-error {
    echo "$ERROR_MSG"
    echo
}

function init {
    # Initialize `dns` command:
    #   1) create `$CONFIG_PATH`
    #   2) add `shecan` and `403` dns configs to $CONFIG_PATH

    mkdir -p $CONFIG_PATH

    echo "$dns_shecan" >$HOME/.config/dns/dns.list.d/shecan
    echo "$dns_403" >$HOME/.config/dns/dns.list.d/403
}

function list-dns {
    # List all `dns configs` in `$CONFIG_PATH`

    for _config in $(ls $CONFIG_PATH); do
        echo "config: \"$_config\""

        for _dns in $(cat $CONFIG_PATH/$_config); do
            echo "  $_dns"
        done

        echo
    done
}

function set-dns {
    # Setup dns from given `dns config`
    # `dns config` is the name of a file in $CONFIG_PATH

    sudo bash -c "echo -e \"# Generated by 'dns' command\n\" >/etc/resolve.conf"
    sudo bash -c "echo \"# config: $1\" >>/etc/resolve.conf"

    for _dns in $(cat $CONFIG_PATH/$1); do
        sudo bash -c "echo \"nameserver $_dns\" >>/etc/resolve.conf"
    done
}

case $1 in
"")
    cat /etc/resolve.conf
    ;;

"-s" | "--set" | "set")
    set-dns $2
    ;;

"-i" | "--init" | "init")
    init
    ;;

"-l" | "--list" | "list")
    list-dns
    ;;

"-h" | "--help" | "help")
    show-help
    ;;

*)
    show-error
    show-help
    exit 1
    ;;
esac
